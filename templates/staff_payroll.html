{% extends "base.html" %}
{% block title %}My Payroll - Easy Hotel{% endblock %}
{% block content %}
<div class="container py-4">
    <h2 class="mb-4">My Payroll</h2>
    <div class="mb-4">
        <a href="{{ url_for('staff_dashboard') }}" class="btn btn-secondary">Back to Dashboard</a>
    </div>
    <div class="row">
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header bg-success text-white">Last Payroll</div>
                <div class="card-body">
                    {% if last_payroll %}
                        <p><strong>Period:</strong> {{ last_payroll.period_start }} - {{ last_payroll.period_end }}</p>
                        <p><strong>Total Hours:</strong> {{ last_payroll.total_hours|round(2) }}</p>
                        <p><strong>Overtime:</strong> {{ last_payroll.overtime_hours|round(2) }}</p>
                        <p><strong>Gross Pay:</strong> ₱{{ last_payroll.gross_pay|round(2) }}</p>
                        <p><strong>Deductions:</strong> ₱{{ last_payroll.deductions|round(2) }}</p>
                        <p><strong>Bonuses:</strong> ₱{{ last_payroll.bonuses|round(2) }}</p>
                        <p><strong>Net Pay:</strong> ₱{{ last_payroll.net_pay|round(2) }}</p>
                        <p><strong>Date Issued:</strong> {{ last_payroll.date_issued.strftime('%B %d, %Y') }}</p>
                    {% else %}
                        <p>No previous payroll found.</p>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header bg-info text-white">Next Payroll</div>
                <div class="card-body">
                    {% if next_payroll %}
                        <p><strong>Period:</strong> {{ next_payroll.period_start }} - {{ next_payroll.period_end }}</p>
                        <p><strong>Expected Net Pay:</strong> ₱{{ next_payroll.net_pay|round(2) }}</p>
                        <p><strong>Pay Date:</strong> {{ next_payroll.period_end.strftime('%B %d, %Y') }}</p>
                        <p><strong>Status:</strong> {{ next_payroll.status }}</p>
                    {% else %}
                        <p>No upcoming payroll found.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    <hr>
    <h3 class="mt-4">Payroll History</h3>
    <div class="table-responsive">
        <table class="table table-striped table-bordered">
            <thead>
                <tr>
                    <th>Period</th>
                    <th>Total Hours</th>
                    <th>Overtime</th>
                    <th>Gross Pay</th>
                    <th>Deductions</th>
                    <th>Bonuses</th>
                    <th>Net Pay</th>
                    <th>Date Issued</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for payroll in payroll_history %}
                <tr>
                    <td>{{ payroll.period_start }} - {{ payroll.period_end }}</td>
                    <td>{{ payroll.total_hours|round(2) }}</td>
                    <td>{{ payroll.overtime_hours|round(2) }}</td>
                    <td>₱{{ payroll.gross_pay|round(2) }}</td>
                    <td>₱{{ payroll.deductions|round(2) }}</td>
                    <td>₱{{ payroll.bonuses|round(2) }}</td>
                    <td>₱{{ payroll.net_pay|round(2) }}</td>
                    <td>{{ payroll.date_issued.strftime('%B %d, %Y') }}</td>
                    <td>{{ payroll.status }}</td>
                    <td>
                        {% if payroll.status == 'pending' %}
                        <form method="POST" action="{{ url_for('delete_staff_payroll', payroll_id=payroll.id) }}" style="display:inline;">
                            <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('Delete this payroll?')">Delete</button>
                        </form>
                        {% endif %}
                        {% if payroll.status == 'paid' %}
                        <button class="btn btn-sm btn-outline-secondary" onclick="downloadPayslipPDF({{ payroll.id }})"><i class="fas fa-file-pdf me-2"></i>Payslip</button>
                        <div id="payslip-content-{{ payroll.id }}" style="display:none;">
                            <h3>Payslip</h3>
                            <p><strong>Period:</strong> {{ payroll.period_start }} - {{ payroll.period_end }}</p>
                            <p><strong>Total Hours:</strong> {{ payroll.total_hours|round(2) }}</p>
                            <p><strong>Overtime:</strong> {{ payroll.overtime_hours|round(2) }}</p>
                            <p><strong>Gross Pay:</strong> ₱{{ payroll.gross_pay|round(2) }}</p>
                            <p><strong>Deductions:</strong> ₱{{ payroll.deductions|round(2) }}</p>
                            <p><strong>Bonuses:</strong> ₱{{ payroll.bonuses|round(2) }}</p>
                            <p><strong>Net Pay:</strong> ₱{{ payroll.net_pay|round(2) }}</p>
                            <p><strong>Date Issued:</strong> {{ payroll.date_issued.strftime('%B %d, %Y') }}</p>
                        </div>
                        {% endif %}
                    </td>
                </tr>
                {% else %}
                <tr><td colspan="10" class="text-center">No payroll history found.</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}
<!-- Add jsPDF and html2canvas for PDF export -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script>
function downloadPayslipPDF(payrollId) {
    const payslip = document.getElementById('payslip-content-' + payrollId);
    payslip.style.display = 'block';
    html2canvas(payslip).then(canvas => {
        const imgData = canvas.toDataURL('image/png');
        const pdf = new window.jspdf.jsPDF();
        const imgProps= pdf.getImageProperties(imgData);
        const pdfWidth = pdf.internal.pageSize.getWidth();
        const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
        pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
        pdf.save('Payslip.pdf');
        payslip.style.display = 'none';
    });
}
</script> 